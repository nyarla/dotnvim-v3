---
name: Lua test for dotnvim v3

on:
  pull_request:
    paths:
      - ".github/workflows/dotnvim-test.yml"
      - "colors/**"
      - "lua/**"
      - "spec/**"
  push:
    branches:
      - main

jobs:
  lua-test:
    runs-on: ubuntu-latest
    steps:
      # runner environment
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      # setup nvim
      - uses: rhysd/action-setup-vim@47493751bcbf7a4b12bc9e0c2ddce7aa1e3b69e5 # v1.4.1
        with:
          neovim: true
          version: v0.9.5

      # setup plenary.nvim
      - name: setup plenary.nvim
        run: |
          set -euo pipefail

          export HEAD=a3e3bc82a3f95c5ed0d7201546d5d2c19b20d683
          export CWD=$(pwd)

          mkdir -p ~/.local/share/nvim/site/pack/vendor/start/plenary.nvim
          cd ~/.local/share/nvim/site/pack/vendor/start/plenary.nvim
          git init
          git remote add origin https://github.com/nvim-lua/plenary.nvim.git
          git fetch --depth 1 origin $HEAD
          git reset --hard $HEAD

      # run tests
      - name: run tests for kalaclista
        run: |
          nvim --headless --noplugin -u tests/init.vim -c "PlenaryBustedDirectory tests/ {minimal_init = 'tests/init.vim'}"
